Bootstrap: docker
From: nvidia/cuda:12.8.0-base-ubuntu24.04

%post
    # install build deps
    apt-get -q update
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
        git \
        wget \
        python-dev-is-python3 \
        python3-venv \
        python3-pip \
        build-essential \
        software-properties-common

    # create and activate virtual environment
    python3 -m venv /opt/venv
    . /opt/venv/bin/activate

    # clone repository
    git clone https://github.com/PapenfussLab/fampnn.git /app/fampnn && cd /app/fampnn && git checkout 18363df

    # install  dependencies
    pip install scipy certifi torch-geometric gemmi biopython tqdm natsort omegaconf rdkit einops hydra-core torchtyping dm-tree timm jaxtyping joblib pandas

    # install fampnn package
    pip install -e .

    # cleanup
    rm -rf /var/lib/apt/lists/*
    apt-get autoremove -y
    apt-get clean

    # link venv
    echo '. /opt/venv/bin/activate' >> $APPTAINER_ENVIRONMENT

%environment
    export PYTHONPATH="/app/fampnn:$PYTHONPATH"

%runscript
    cd /app/fampnn
    if [ $# -eq 0 ]; then
        exec /bin/bash --norc
    else
        exec "$@"
    fi

%test
    pip show fampnn

%labels
    Author JoshuaHardy, DylanSilke
    Version 1.0
    Description "Apptainer container for Full-atom MPNN (fampnn)"

%help
    Container for running fampnn with CUDA 12.8
    Execute with GPU support using: apptainer run --nv fampnn.sif